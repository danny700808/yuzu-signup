<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>柚子樂器成果展｜報名</title>
  <style>
    *{ box-sizing:border-box; }
    html,body{ width:100%; overflow-x:hidden; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
      background:#faf7f8;
      color:#222;
    }
    .wrap{ max-width:860px; margin:24px auto; padding:16px; }
    .card{
      background:#fff;
      border:1px solid #eee;
      border-radius:16px;
      padding:18px;
      box-shadow:0 8px 22px rgba(0,0,0,.06);
    }
    h1{ margin:0 0 10px; font-size:22px; }
    .muted{ color:#666; font-size:13px; line-height:1.6; white-space:pre-wrap; }
    label{ display:block; margin:12px 0 6px; font-weight:800; }
    input,select,textarea{
      width:100%;
      max-width:100%;
      display:block;
      padding:12px;
      border:1px solid #ddd;
      border-radius:12px;
      font-size:16px;
      background:#fff;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{ border-color:#caa0ae; box-shadow:0 0 0 3px rgba(202,160,174,.25); }
    textarea{ min-height:90px; resize:vertical; }
    .row{
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(0,1fr);
      gap:12px;
    }
    @media (max-width:640px){ .row{ grid-template-columns:1fr; } }

    .btn{
      margin-top:14px;
      width:100%;
      padding:12px;
      border:0;
      border-radius:12px;
      font-size:16px;
      background:#7b3a52;
      color:#fff;
      cursor:pointer;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .btnG{
      margin-top:10px;
      width:100%;
      padding:14px;
      border:0;
      border-radius:12px;
      font-size:17px;
      background:#2f8f7b;
      color:#fff;
      cursor:pointer;
    }
    .btnG:disabled{ opacity:.6; cursor:not-allowed; }

    .ghost{
      border:1px solid #d1d5db;
      background:#fff;
      color:#111827;
    }

    .ok{ color:#0a7a3c; font-weight:900; }
    .err{ color:#b00020; font-weight:900; }

    .box{
      background:#f6fbf9;
      border:1px solid #d7efe7;
      border-radius:14px;
      padding:14px;
      margin-top:14px;
    }
    .hr{ height:1px; background:#eee; margin:14px 0; }

    /* 大選檔按鈕 */
    .slot{
      border:1px solid #d7efe7;
      background:#ffffff;
      border-radius:14px;
      padding:12px;
      margin-top:12px;
    }
    .slotTitle{
      font-weight:900;
      margin:0 0 10px;
      font-size:16px;
      color:#1f2937;
    }
    .fileRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .fileBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:14px 16px;
      border-radius:12px;
      border:1px solid #cfe9e1;
      background:#eaf7f3;
      color:#1f2937;
      font-weight:900;
      cursor:pointer;
      min-width:160px;
      user-select:none;
    }
    .fileName{
      color:#374151;
      font-size:14px;
      word-break:break-word;
      flex:1;
      min-width:180px;
    }
    .slotMsg{ margin-top:10px; font-size:13px; white-space:pre-wrap; }

    /* 完成卡片：完成後整頁只剩這個 */
    .doneOnly{
      display:none;
      border:1px solid #b7e4c7;
      background:#ecfdf3;
      border-radius:14px;
      padding:16px;
    }
    .doneHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .doneTitle{
      font-weight:900;
      color:#0a7a3c;
      font-size:22px;
      margin:0;
    }
    .doneX{
      border:0;
      background:transparent;
      cursor:pointer;
      font-size:20px;
      color:#0a7a3c;
      padding:6px;
      line-height:1;
    }
    .doneBody{
      margin-top:10px;
      color:#374151;
      font-size:14px;
      white-space:pre-wrap;
      line-height:1.7;
    }
    .doneActions{
      display:flex;
      gap:12px;
      margin-top:14px;
      flex-wrap:wrap;
    }
    .doneActions button{ flex:1; min-width:170px; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card" id="mainCard">
    <h1>柚子樂器成果展｜報名</h1>

    <form id="f">
      <label>場次 *</label>
      <select name="場次" required>
        <option value="">請選擇</option>
        <option>下午場 13:00~16:00</option>
        <option>晚上場 17:30~20:30</option>
      </select>

      <label>表演項目 *</label>
      <select name="表演項目" required>
        <option value="">請選擇</option>
        <option>熱音樂團</option>
        <option>輕音樂團</option>
        <option>吉他彈唱</option>
        <option>鋼琴獨奏</option>
        <option>鋼琴雙人</option>
        <option>小提琴</option>
        <option>中國笛</option>
        <option>長笛木笛直笛</option>
        <option>爵士鼓獨奏</option>
        <option>鋼琴彈唱</option>
        <option>二胡</option>
        <option>琵琶</option>
        <option>其他</option>
      </select>

      <label>學生姓名 *</label>
      <input name="學生姓名" required placeholder="例：王小明">

      <label>表演者姓名 / 團名 *</label>
      <input name="表演者姓名/團名" required placeholder="例：@@吉他社 / @@小提琴中心">

      <div class="row">
        <div>
          <label>舞台總表演人數 *</label>
          <input name="舞台總表演人數" required inputmode="numeric" placeholder="例：2 / 4">
        </div>
        <div>
          <label>聯絡電話 *</label>
          <input name="聯絡電話" required inputmode="tel" placeholder="例：0952-010146">
        </div>
      </div>

      <label>表演歌名/名稱 *</label>
      <input name="表演歌名/名稱" required placeholder="例：浪流連">

      <label>聯絡人信箱（老師代報也填老師信箱） *</label>
      <input name="聯絡人信箱" type="email" required placeholder="example@example.com">

      <label>老師是否一同表演</label>
      <select name="老師是否一同表演">
        <option value="">請選擇</option>
        <option>是</option>
        <option>否</option>
      </select>

      <label>老師一起的方式（沒有就留空）</label>
      <input name="老師一起的方式" placeholder="例：鋼琴伴奏">

      <label>老師姓名(代報填)</label>
      <input name="老師姓名(代報填)" placeholder="例：黃明廷">

      <label>需求/備註</label>
      <textarea name="需求/備註" placeholder="想補充的內容…"></textarea>

      <!-- create: 下一步｜添加音檔；edit: 儲存修改（覆蓋）（放最下面） -->
      <button class="btn" type="submit" id="btnMain">下一步｜添加音檔</button>
      <p id="msg" class="muted"></p>

      <!-- ✅ 添加音檔（極簡） -->
      <div class="box" id="audioBox" style="display:none;">
        <div style="font-weight:900;font-size:18px;">添加音檔（MP3 ≤ 20MB）</div>
        <div class="muted" style="margin-top:6px;">備註：最多可上傳 3 個音檔。</div>

        <!-- 三個音檔槽位 -->
        <div class="slot" id="slot1">
          <div class="slotTitle">音檔 1</div>
          <input id="file1" type="file" accept="audio/mpeg,.mp3" style="display:none;">
          <div class="fileRow">
            <div class="fileBtn" data-pick="1">選擇檔案</div>
            <div class="fileName" id="name1">尚未選取檔案</div>
          </div>
          <button type="button" class="btnG" data-upload="1">上傳音檔 1</button>
          <div class="slotMsg muted" id="m1"></div>
        </div>

        <div class="slot" id="slot2">
          <div class="slotTitle">音檔 2</div>
          <input id="file2" type="file" accept="audio/mpeg,.mp3" style="display:none;">
          <div class="fileRow">
            <div class="fileBtn" data-pick="2">選擇檔案</div>
            <div class="fileName" id="name2">尚未選取檔案</div>
          </div>
          <button type="button" class="btnG" data-upload="2">上傳音檔 2</button>
          <div class="slotMsg muted" id="m2"></div>
        </div>

        <div class="slot" id="slot3">
          <div class="slotTitle">音檔 3</div>
          <input id="file3" type="file" accept="audio/mpeg,.mp3" style="display:none;">
          <div class="fileRow">
            <div class="fileBtn" data-pick="3">選擇檔案</div>
            <div class="fileName" id="name3">尚未選取檔案</div>
          </div>
          <button type="button" class="btnG" data-upload="3">上傳音檔 3</button>
          <div class="slotMsg muted" id="m3"></div>
        </div>

        <div class="hr"></div>

        <!-- ✅ 完成按鈕（已上傳完要結束就按這個） -->
        <button type="button" class="btnG" id="btnFinish">我已上傳完成（完成）</button>

        <!-- ✅ 不需要音檔（清除1~3並完成） -->
        <button type="button" class="btnG" id="btnNoAudio">我的表演不需要音檔（完成）</button>

        <p class="muted" style="margin-top:10px;">
若檔案超過 20MB，請先轉檔/壓縮後再上傳。你可以在 Google 搜尋「MP3 轉檔」。
        </p>

        <!-- 修改模式：儲存放最下面 -->
        <button class="btn" type="submit" id="btnSaveBottom" style="display:none;">儲存修改（覆蓋）</button>
      </div>
    </form>
  </div>

  <!-- ✅ 完成後整頁只顯示這張卡 -->
  <div class="doneOnly" id="doneCard">
    <div class="doneHead">
      <h2 class="doneTitle">✅ 已完成</h2>
      <button class="doneX" id="doneX" aria-label="close">✕</button>
    </div>
    <div class="doneBody" id="doneBody"></div>
    <div class="doneActions">
      <button class="btnG" id="btnGoOfficial">立即前往官方網站</button>
      <button class="btnG ghost" id="btnBackForm">回到報名表（新增下一位）</button>
    </div>
  </div>
</div>

<script>
  // 你的 Apps Script Web App /exec
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyeOeFb5TpiWga7GecrRbUA9x3W-cMGdT5XA5vQetjZYKWAl0_RhrDYuFXOBxW2bXXP/exec";
  // 你的官網
  const OFFICIAL_URL = "https://www.mingtinghuang.com/";
  const COUNTDOWN_SECONDS = 20;

  const f = document.getElementById("f");
  const msg = document.getElementById("msg");
  const btnMain = document.getElementById("btnMain");
  const audioBox = document.getElementById("audioBox");
  const btnSaveBottom = document.getElementById("btnSaveBottom");

  const doneCard = document.getElementById("doneCard");
  const doneBody = document.getElementById("doneBody");
  const doneX = document.getElementById("doneX");
  const btnGoOfficial = document.getElementById("btnGoOfficial");
  const btnBackForm = document.getElementById("btnBackForm");

  const btnFinish = document.getElementById("btnFinish");
  const btnNoAudio = document.getElementById("btnNoAudio");

  let mode = "create"; // create | edit
  let current = { regId:"", token:"" };
  let countdownTimer = null;
  let left = COUNTDOWN_SECONDS;

  function stopCountdown(){
    if(countdownTimer){
      clearInterval(countdownTimer);
      countdownTimer = null;
    }
  }

  function showDoneOnly(){
    // 完成後：整頁只剩完成卡片
    document.getElementById("mainCard").style.display = "none";
    doneCard.style.display = "block";
    doneCard.scrollIntoView({behavior:"smooth", block:"start"});

    stopCountdown();
    left = COUNTDOWN_SECONDS;
    renderDoneBody();

    countdownTimer = setInterval(()=>{
      left -= 1;
      renderDoneBody();
      if(left <= 0){
        stopCountdown();
        location.href = OFFICIAL_URL;
      }
    }, 1000);
  }

  function renderDoneBody(){
    doneBody.textContent =
      "附註：若之後需要修改資料或補上傳/重傳音檔覆蓋，請到信件內點選「回到修改頁」。\n" +
      `${COUNTDOWN_SECONDS} 秒後將自動前往官方網站（倒數：${left}）`;
  }

  doneX.addEventListener("click", ()=>{
    // 關閉完成卡：仍視為完成結束，提供回到報名表/官網即可
    stopCountdown();
  });
  btnGoOfficial.addEventListener("click", ()=>{
    stopCountdown();
    location.href = OFFICIAL_URL;
  });
  btnBackForm.addEventListener("click", ()=>{
    stopCountdown();
    // 回到空白報名表（新增下一位）
    const base = location.origin + location.pathname; // 去掉 regId/token
    location.href = base;
  });

  function getQuery(){
    const p = new URLSearchParams(location.search);
    return { regId:(p.get("regId")||"").trim(), token:(p.get("token")||"").trim() };
  }

  function mb(n){ return n/(1024*1024); }
  function fmtMB(n){ return (Math.round(mb(n)*100)/100).toFixed(2); }

  function setSlotMsg(slot, text, isErr){
    const el = document.getElementById("m"+slot);
    el.className = "slotMsg " + (isErr ? "err" : "muted");
    el.textContent = text || "";
  }

  // ArrayBuffer -> base64
  function arrayBufferToBase64(buf){
    const bytes = new Uint8Array(buf);
    let bin = "";
    const step = 0x8000;
    for(let i=0;i<bytes.length;i+=step){
      bin += String.fromCharCode(...bytes.subarray(i, i+step));
    }
    return btoa(bin);
  }

  async function initEditMode(){
    const q = getQuery();
    if(!q.regId || !q.token) return;

    mode = "edit";
    current.regId = q.regId;
    current.token = q.token;

    // 修改模式：把儲存按鈕放最下面（你指定）
    btnMain.style.display = "none";
    btnSaveBottom.style.display = "";
    audioBox.style.display = "";

    msg.textContent = "";
    try{
      const j = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify({ mode:"get", regId:q.regId, token:q.token })
      }).then(r=>r.json());

      if(!j.ok) throw new Error(j.error || "讀取失敗");

      const data = j.data || {};
      for(const k in data){
        const el = f.querySelector(`[name="${k}"]`);
        if(el) el.value = data[k];
      }
    }catch(e){
      msg.className = "err";
      msg.textContent = "讀取失敗：" + e.message;
    }
  }

  // 送出報名 / 儲存修改（覆蓋）
  f.addEventListener("submit", async (ev)=>{
    ev.preventDefault();
    msg.className = "muted";
    msg.textContent = (mode==="edit") ? "儲存中…" : "送出中…";
    btnMain.disabled = true;
    btnSaveBottom.disabled = true;

    const data = Object.fromEntries(new FormData(f).entries());

    if(mode === "edit"){
      data.mode = "update";
      data.regId = current.regId;
      data.token = current.token;
    }else{
      data.mode = "create";
    }

    try{
      const j = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify(data)
      }).then(r=>r.json());

      if(!j.ok) throw new Error(j.error || "unknown");

      if(mode !== "edit"){
        current.regId = j.regId;
        current.token = j.token;

        // ✅ 送出後只顯示音檔區（極簡），不顯示編號/姓名/歌名等資訊
        audioBox.style.display = "";
        audioBox.scrollIntoView({behavior:"smooth", block:"start"});

        // 按鈕改成已完成（表單提交完成）
        btnMain.textContent = "已完成";
        btnMain.disabled = true;

        msg.className = "muted";
        msg.textContent = "";
      }else{
        // 修改儲存成功：直接進完成卡片（你要求）
        msg.textContent = "";
        showDoneOnly();
      }
    }catch(e){
      msg.className = "err";
      msg.textContent = ((mode==="edit") ? "儲存失敗：" : "送出失敗：") + e.message;
      if(mode!=="edit") btnMain.disabled = false;
    }finally{
      btnSaveBottom.disabled = false;
    }
  });

  // 3 個選檔按鈕
  document.querySelectorAll(".fileBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const slot = btn.getAttribute("data-pick");
      document.getElementById("file"+slot).click();
    });
  });

  // 顯示檔名與大小
  [1,2,3].forEach(slot=>{
    const input = document.getElementById("file"+slot);
    input.addEventListener("change", ()=>{
      const file = input.files && input.files[0];
      const nameEl = document.getElementById("name"+slot);
      if(!file){
        nameEl.textContent = "尚未選取檔案";
        setSlotMsg(slot, "");
        return;
      }
      nameEl.textContent = `${file.name}（${fmtMB(file.size)} MB）`;
    });
  });

  // 上傳單一槽位
  async function uploadSlot(slot){
    setSlotMsg(slot, "");
    if(!current.regId || !current.token){
      setSlotMsg(slot, "請先完成報名（下一步｜添加音檔）或用信件連結進入修改頁。", true);
      return;
    }

    const input = document.getElementById("file"+slot);
    const file = input.files && input.files[0];
    if(!file){
      setSlotMsg(slot, "請先選擇 MP3 檔案（≤ 20MB）。", true);
      return;
    }

    if(file.size > 20*1024*1024){
      setSlotMsg(slot, `檔案太大：${fmtMB(file.size)} MB（上限 20MB）。可在 Google 搜尋「MP3 轉檔」。`, true);
      return;
    }

    const lower = (file.name||"").toLowerCase();
    const isMp3 = (file.type === "audio/mpeg") || lower.endsWith(".mp3");
    if(!isMp3){
      setSlotMsg(slot, "只接受 MP3（.mp3）。", true);
      return;
    }

    try{
      setSlotMsg(slot, "建立上傳通道…");

      const startRes = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify({
          mode:"startUpload",
          regId: current.regId,
          token: current.token,
          slot: slot,
          totalBytes: file.size,
          originalName: file.name
        })
      }).then(r=>r.json());

      if(!startRes.ok) throw new Error(startRes.error || "建立上傳通道失敗");

      const uploadUrl = startRes.uploadUrl;
      const finalName = startRes.finalName;

      const chunkSize = 1024*1024;
      let offset = 0;

      while(offset < file.size){
        const next = Math.min(offset + chunkSize, file.size);
        const blob = file.slice(offset, next);
        const buf = await blob.arrayBuffer();
        const chunkB64 = arrayBufferToBase64(buf);

        const pct = Math.round((next / file.size) * 100);
        setSlotMsg(slot, `上傳中… ${pct}%`);

        const chunkRes = await fetch(SCRIPT_URL, {
          method:"POST",
          headers:{ "Content-Type":"text/plain;charset=utf-8" },
          body: JSON.stringify({
            mode:"uploadChunk",
            regId: current.regId,
            token: current.token,
            slot: slot,
            uploadUrl: uploadUrl,
            start: offset,
            end: next - 1,
            total: file.size,
            chunkBase64: chunkB64
          })
        }).then(r=>r.json());

        if(!chunkRes.ok) throw new Error(chunkRes.error || "分段上傳失敗");

        if(chunkRes.done){
          setSlotMsg(slot, `✅ 音檔 ${slot} 已上傳完成：${chunkRes.fileName || finalName}`, false);
          return;
        }

        offset = next;
      }
    }catch(e){
      setSlotMsg(slot, "上傳失敗：" + e.message, true);
    }
  }

  // 綁三個上傳按鈕
  document.querySelectorAll("[data-upload]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const slot = Number(btn.getAttribute("data-upload"));
      uploadSlot(slot);
    });
  });

  // 我已上傳完成（完成）→ 直接進完成卡片
  btnFinish.addEventListener("click", ()=>{
    showDoneOnly();
  });

  // 不需要音檔（完成）→ 清掉 1~3 並進完成卡片
  btnNoAudio.addEventListener("click", async ()=>{
    if(!current.regId || !current.token){
      showDoneOnly(); // 若未有 regId/token，就當作結束返回即可
      return;
    }
    try{
      const j = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify({ mode:"noAudio", regId: current.regId, token: current.token })
      }).then(r=>r.json());

      if(!j.ok) throw new Error(j.error || "處理失敗");
      showDoneOnly();
    }catch(e){
      // 不阻擋完成，只顯示錯誤在 slot1（避免多訊息）
      setSlotMsg(1, "處理失敗：" + e.message, true);
    }
  });

  // 初始化：如果有 regId/token → 修改模式
  initEditMode();
</script>
</body>
</html>
