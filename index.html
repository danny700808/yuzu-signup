<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>柚子樂器成果展｜報名</title>
  <style>
    *{ box-sizing:border-box; }
    html,body{ width:100%; overflow-x:hidden; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
      background:#faf7f8;
      color:#222;
    }
    .wrap{ max-width:860px; margin:24px auto; padding:16px; }
    .card{
      background:#fff;
      border:1px solid #eee;
      border-radius:16px;
      padding:18px;
      box-shadow:0 8px 22px rgba(0,0,0,.06);
    }
    h1{ margin:0 0 10px; font-size:22px; }
    .muted{ color:#666; font-size:13px; line-height:1.6; white-space:pre-wrap; }
    label{ display:block; margin:12px 0 6px; font-weight:800; }
    input,select,textarea{
      width:100%;
      max-width:100%;
      display:block;
      padding:12px;
      border:1px solid #ddd;
      border-radius:12px;
      font-size:16px;
      background:#fff;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{ border-color:#caa0ae; box-shadow:0 0 0 3px rgba(202,160,174,.25); }
    textarea{ min-height:90px; resize:vertical; }
    .row{
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(0,1fr);
      gap:12px;
    }
    @media (max-width:640px){ .row{ grid-template-columns:1fr; } }

    .btn{
      margin-top:14px;
      width:100%;
      padding:12px;
      border:0;
      border-radius:12px;
      font-size:16px;
      background:#7b3a52;
      color:#fff;
      cursor:pointer;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    /* ✅ 綠色重要按鈕（上傳、完成都用這個） */
    .btnG{
      margin-top:10px;
      width:100%;
      padding:14px;
      border:0;
      border-radius:12px;
      font-size:17px;
      background:#2f8f7b;
      color:#fff;
      cursor:pointer;
    }
    .btnG:disabled{ opacity:.6; cursor:not-allowed; }

    .ok{ color:#0a7a3c; font-weight:900; }
    .err{ color:#b00020; font-weight:900; }

    .box{
      background:#f6fbf9;
      border:1px solid #d7efe7;
      border-radius:14px;
      padding:14px;
      margin-top:14px;
    }
    .hr{ height:1px; background:#eee; margin:14px 0; }
    .bar{ width:100%; height:14px; }
    code{ background:#f6f6f6; padding:2px 6px; border-radius:8px; }

    /* ✅ 大選檔按鈕 */
    .fileRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .fileBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:14px 16px;
      border-radius:12px;
      border:1px solid #cfe9e1;
      background:#eaf7f3;
      color:#1f2937;
      font-weight:900;
      cursor:pointer;
      min-width:160px;
      user-select:none;
    }
    .fileName{
      color:#374151;
      font-size:14px;
      word-break:break-word;
      flex:1;
      min-width:180px;
    }

    /* ✅ 完成提示框（同頁可關閉 + 倒數導頁） */
    .notice{
      display:none;
      margin-top:12px;
      border:1px solid #b7e4c7;
      background:#ecfdf3;
      border-radius:14px;
      padding:14px 14px;
      position:relative;
    }
    .notice .x{
      position:absolute; right:10px; top:8px;
      border:0; background:transparent; cursor:pointer;
      font-size:18px; line-height:1;
      color:#0a7a3c;
      padding:6px;
    }
    .notice .title{ font-weight:900; color:#0a7a3c; margin-bottom:6px; font-size:18px; }
    .notice .actions{ display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; }
    .notice .actions button{ flex:1; min-width:170px; }
    .ghost{
      border:1px solid #d1d5db;
      background:#fff;
      color:#111827;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>柚子樂器成果展｜報名</h1>

    <p class="muted">
送出基本資料後，你可以選擇是否添加音檔（MP3 ≤ 20MB）。
音檔檔名會自動改成：學生姓名_歌名_報名編號.mp3
    </p>

    <form id="f">
      <label>場次 *</label>
      <select name="場次" required>
        <option value="">請選擇</option>
        <option>下午場 13:00~16:00</option>
        <option>晚上場 17:30~20:30</option>
      </select>

      <label>表演項目 *</label>
      <select name="表演項目" required>
        <option value="">請選擇</option>
        <option>熱音樂團</option>
        <option>輕音樂團</option>
        <option>吉他彈唱</option>
        <option>鋼琴獨奏</option>
        <option>鋼琴雙人</option>
        <option>小提琴</option>
        <option>中國笛</option>
        <option>長笛木笛直笛</option>
        <option>爵士鼓獨奏</option>
        <option>鋼琴彈唱</option>
        <option>二胡</option>
        <option>琵琶</option>
        <option>其他</option>
      </select>

      <label>學生姓名 *</label>
      <input name="學生姓名" required placeholder="例：王小明">

      <label>表演者姓名 / 團名 *</label>
      <input name="表演者姓名/團名" required placeholder="例：@@吉他社 / @@小提琴中心">

      <div class="row">
        <div>
          <label>舞台總表演人數 *</label>
          <input name="舞台總表演人數" required inputmode="numeric" placeholder="例：2 / 4">
        </div>
        <div>
          <label>聯絡電話 *</label>
          <input name="聯絡電話" required inputmode="tel" placeholder="例：0952-010146">
        </div>
      </div>

      <label>表演歌名/名稱 *</label>
      <input name="表演歌名/名稱" required placeholder="例：浪流連">

      <label>聯絡人信箱（老師代報也填老師信箱） *</label>
      <input name="聯絡人信箱" type="email" required placeholder="example@example.com">

      <label>老師是否一同表演</label>
      <select name="老師是否一同表演">
        <option value="">請選擇</option>
        <option>是</option>
        <option>否</option>
      </select>

      <label>老師一起的方式（沒有就留空）</label>
      <input name="老師一起的方式" placeholder="例：鋼琴伴奏">

      <label>老師姓名(代報填)</label>
      <input name="老師姓名(代報填)" placeholder="例：黃明廷">

      <label>需求/備註</label>
      <textarea name="需求/備註" placeholder="想補充的內容…"></textarea>

      <!-- ✅ create: 下一步｜添加音檔；edit: 儲存修改（覆蓋） -->
      <button class="btn" type="submit" id="btnMain">下一步｜添加音檔</button>
      <p id="msg" class="muted"></p>

      <!-- ✅ 完成提示（第2張圖那種） -->
      <div class="notice" id="notice">
        <button type="button" class="x" id="btnNoticeClose" aria-label="close">✕</button>
        <div class="title" id="noticeTitle">✅ 已完成</div>
        <div class="muted" id="noticeBody"></div>
        <div class="actions">
          <button type="button" class="btnG" id="btnGoNow">立即前往官方網站</button>
          <button type="button" class="btnG ghost" id="btnCancelCountdown">取消倒數</button>
        </div>
      </div>

      <!-- ✅ 你紅框那個上傳區塊 -->
      <div class="box" id="audioBox" style="display:none;">
        <div class="muted" id="audioInfo"></div>
        <div class="hr"></div>

        <label style="margin-top:0;font-size:18px;">添加音檔（MP3 ≤ 20MB）</label>

        <!-- ✅ 大選檔按鈕（替代小小的瀏覽器預設按鈕） -->
        <input id="audioFile" type="file" accept="audio/mpeg,.mp3" style="display:none;">
        <div class="fileRow">
          <div class="fileBtn" id="btnPick">選擇檔案</div>
          <div class="fileName" id="pickedName">尚未選取檔案</div>
        </div>
        <div class="muted" id="fileMeta"></div>

        <!-- ✅ 兩顆都綠色（你指定同等重要） -->
        <button type="button" class="btnG" id="btnUpload">上傳音檔</button>
        <button type="button" class="btnG" id="btnNoAudio">我的表演不需要音檔（完成）</button>

        <div style="margin-top:12px;">
          <progress id="prog" class="bar" value="0" max="100"></progress>
          <div class="muted" id="progText">等待上傳…</div>
        </div>

        <p id="audioMsg" class="muted"></p>

        <div class="hr"></div>
        <p class="muted">
若檔案超過 20MB，請先轉檔/壓縮後再上傳。
你可以在 Google 搜尋「MP3 轉檔」快速找到工具。
        </p>
      </div>

      <!-- ✅ 修改模式：把「儲存修改」放最下面（你指定） -->
      <div style="margin-top:16px;">
        <button class="btn" type="submit" id="btnSaveBottom" style="display:none;">儲存修改（覆蓋）</button>
      </div>
    </form>
  </div>
</div>

<script>
  // ✅ 你提供的 Apps Script /exec
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyeOeFb5TpiWga7GecrRbUA9x3W-cMGdT5XA5vQetjZYKWAl0_RhrDYuFXOBxW2bXXP/exec";

  // ✅ 你提供的官網（完成後倒數導頁）
  const OFFICIAL_URL = "https://www.mingtinghuang.com/";

  const f = document.getElementById("f");
  const msg = document.getElementById("msg");
  const btnMain = document.getElementById("btnMain");
  const btnSaveBottom = document.getElementById("btnSaveBottom");

  const audioBox = document.getElementById("audioBox");
  const audioInfo = document.getElementById("audioInfo");
  const audioFile = document.getElementById("audioFile");
  const btnPick = document.getElementById("btnPick");
  const pickedName = document.getElementById("pickedName");
  const fileMeta = document.getElementById("fileMeta");
  const btnUpload = document.getElementById("btnUpload");
  const btnNoAudio = document.getElementById("btnNoAudio");
  const audioMsg = document.getElementById("audioMsg");
  const prog = document.getElementById("prog");
  const progText = document.getElementById("progText");

  const notice = document.getElementById("notice");
  const noticeTitle = document.getElementById("noticeTitle");
  const noticeBody = document.getElementById("noticeBody");
  const btnNoticeClose = document.getElementById("btnNoticeClose");
  const btnGoNow = document.getElementById("btnGoNow");
  const btnCancelCountdown = document.getElementById("btnCancelCountdown");

  let mode = "create"; // create | edit
  let current = { regId:"", token:"", student:"", song:"", hasAudio:false, audioUrl:"" };

  let countdownTimer = null;
  let countdownLeft = 0;

  function esc(s){
    s = String(s==null?"":s);
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function setProg(pct, text){
    prog.value = Math.max(0, Math.min(100, pct));
    progText.textContent = text || `${prog.value}%`;
  }

  function resetUploadUI(){
    setProg(0, "等待上傳…");
    audioMsg.className = "muted";
    audioMsg.textContent = "";
    btnUpload.disabled = false;
    btnNoAudio.disabled = false;
  }

  function mb(n){ return n/(1024*1024); }
  function fmtMB(n){ return (Math.round(mb(n)*100)/100).toFixed(2); }

  function stopCountdown(){
    if(countdownTimer){
      clearInterval(countdownTimer);
      countdownTimer = null;
    }
  }

  function renderNotice(extra){
    const lines = [];
    if(extra) lines.push(extra);
    lines.push("附註：若之後需要修改資料或補上傳/重傳音檔覆蓋，請到信件內點選「回到修改頁」。");
    lines.push(`20 秒後將自動前往官方網站（倒數：${countdownLeft}）`);
    noticeBody.textContent = lines.join("\n");
  }

  function showNotice(title, extraLine){
    noticeTitle.textContent = title || "✅ 已完成";
    notice.style.display = "block";
    countdownLeft = 20;
    renderNotice(extraLine || "");
    stopCountdown();
    countdownTimer = setInterval(()=>{
      countdownLeft -= 1;
      renderNotice(extraLine || "");
      if(countdownLeft <= 0){
        stopCountdown();
        window.location.href = OFFICIAL_URL;
      }
    }, 1000);

    notice.scrollIntoView({behavior:"smooth", block:"start"});
  }

  btnNoticeClose.addEventListener("click", ()=>{
    stopCountdown();
    notice.style.display = "none";
  });
  btnCancelCountdown.addEventListener("click", ()=>{
    stopCountdown();
    noticeBody.textContent = "附註：若之後需要修改資料或補上傳/重傳音檔覆蓋，請到信件內點選「回到修改頁」。";
  });
  btnGoNow.addEventListener("click", ()=>{
    stopCountdown();
    window.location.href = OFFICIAL_URL;
  });

  btnPick.addEventListener("click", ()=> audioFile.click());

  audioFile.addEventListener("change", ()=>{
    const file = audioFile.files && audioFile.files[0];
    if(!file){
      pickedName.textContent = "尚未選取檔案";
      fileMeta.textContent = "";
      return;
    }
    pickedName.textContent = file.name;
    fileMeta.textContent = `檔案大小：${fmtMB(file.size)} MB`;
    if(file.size > 20*1024*1024){
      fileMeta.textContent += `\n⚠️ 超過 20 MB，請先轉檔/壓縮後再上傳（可在 Google 搜尋「MP3 轉檔」）。`;
    }
  });

  function getQuery(){
    const p = new URLSearchParams(location.search);
    return {
      regId: (p.get("regId") || "").trim(),
      token: (p.get("token") || "").trim()
    };
  }

  async function initFromQuery(){
    const q = getQuery();
    if(!q.regId || !q.token) return;

    mode = "edit";

    // 修改模式：把「儲存修改」放到最下面（你指定）
    btnMain.style.display = "none";
    btnSaveBottom.style.display = "";

    msg.className = "muted";
    msg.textContent = "載入資料中…";

    try{
      const j = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify({ mode:"get", regId:q.regId, token:q.token })
      }).then(r=>r.json());

      if(!j.ok) throw new Error(j.error || "讀取失敗");

      const data = j.data || {};
      for(const k in data){
        const el = f.querySelector(`[name="${k}"]`);
        if(el) el.value = data[k];
      }

      current.regId = q.regId;
      current.token = q.token;
      current.student = (data["學生姓名"]||"").trim();
      current.song = (data["表演歌名/名稱"]||"").trim();

      current.audioUrl = (j.audio && j.audio.fileUrl) ? j.audio.fileUrl : "";
      current.hasAudio = !!current.audioUrl;

      audioBox.style.display = "";
      audioInfo.innerHTML =
        `報名編號：<b>${esc(current.regId)}</b><br>` +
        `學生：<b>${esc(current.student)}</b>　歌名：<b>${esc(current.song)}</b><br>` +
        `檔名會自動改成：<code>${esc(current.student)}_${esc(current.song)}_${esc(current.regId)}.mp3</code>` +
        (current.audioUrl ? `<br>目前音檔：<a href="${current.audioUrl}" target="_blank" rel="noreferrer">點我檢視</a>` : "");

      msg.className = "muted";
      msg.textContent = ""; // 你說不要多餘解釋 → 這裡清空

      resetUploadUI();
      audioBox.scrollIntoView({behavior:"smooth", block:"start"});
    }catch(e){
      msg.className = "err";
      msg.textContent = "讀取失敗：" + e.message;
    }
  }

  // ArrayBuffer -> base64（穩）
  function arrayBufferToBase64(buf){
    const bytes = new Uint8Array(buf);
    let bin = "";
    const step = 0x8000;
    for(let i=0;i<bytes.length;i+=step){
      bin += String.fromCharCode(...bytes.subarray(i, i+step));
    }
    return btoa(bin);
  }

  async function submitForm(isBottom){
    msg.className = "muted";
    msg.textContent = (mode === "edit") ? "儲存中…" : "送出中…";
    (isBottom ? btnSaveBottom : btnMain).disabled = true;

    const data = Object.fromEntries(new FormData(f).entries());

    if(mode === "edit"){
      data.mode = "update";
      data.regId = current.regId;
      data.token = current.token;
    }else{
      data.mode = "create";
    }

    try{
      const j = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify(data)
      }).then(r=>r.json());

      if(!j.ok) throw new Error(j.error || "unknown");

      // 更新 current
      current.regId = j.regId || current.regId;
      current.token = j.token || current.token;
      current.student = (data["學生姓名"]||"").trim();
      current.song = (data["表演歌名/名稱"]||"").trim();

      // ✅ 送出後只要出現你紅框那個上傳框（我們直接顯示+捲動）
      audioBox.style.display = "";
      audioInfo.innerHTML =
        `報名編號：<b>${esc(current.regId)}</b><br>` +
        `學生：<b>${esc(current.student)}</b>　歌名：<b>${esc(current.song)}</b><br>` +
        `檔名會自動改成：<code>${esc(current.student)}_${esc(current.song)}_${esc(current.regId)}.mp3</code>` +
        (current.audioUrl ? `<br>目前音檔：<a href="${current.audioUrl}" target="_blank" rel="noreferrer">點我檢視</a>` : "");

      resetUploadUI();
      audioBox.scrollIntoView({behavior:"smooth", block:"start"});

      // 新報名：主按鈕改「已完成」並鎖住
      if(mode !== "edit"){
        msg.className = "ok";
        msg.textContent = "✅ 報名已完成！你可以在下方添加音檔（或選擇完成）。";
        btnMain.textContent = "已完成";
        btnMain.disabled = true;
      }else{
        // 修改完成：直接跳「已完成」框（你指定）
        msg.textContent = "";
        showNotice("✅ 已完成", "");
        btnSaveBottom.disabled = false;
      }

    }catch(e){
      msg.className = "err";
      msg.textContent = ((mode === "edit") ? "儲存失敗：" : "送出失敗：") + e.message;
      (isBottom ? btnSaveBottom : btnMain).disabled = false;
    }
  }

  f.addEventListener("submit", (ev)=>{
    ev.preventDefault();
    if(mode === "edit") submitForm(true);
    else submitForm(false);
  });

  // 上傳音檔
  btnUpload.addEventListener("click", async ()=>{
    audioMsg.className = "muted";
    audioMsg.textContent = "";

    if(!current.regId || !current.token){
      audioMsg.className = "err";
      audioMsg.textContent = "請先完成報名或載入資料。";
      return;
    }

    const file = audioFile.files && audioFile.files[0];
    if(!file){
      audioMsg.className = "err";
      audioMsg.textContent = "請先選擇 MP3 檔案（≤ 20MB）。";
      return;
    }

    const maxBytes = 20*1024*1024;
    if(file.size > maxBytes){
      audioMsg.className = "err";
      audioMsg.textContent =
        `檔案太大：目前 ${fmtMB(file.size)} MB，超過 20 MB。\n` +
        `你可以在 Google 搜尋「MP3 轉檔」。`;
      return;
    }

    const lower = (file.name||"").toLowerCase();
    const isMp3 = (file.type === "audio/mpeg") || lower.endsWith(".mp3");
    if(!isMp3){
      audioMsg.className = "err";
      audioMsg.textContent = "只接受 MP3（.mp3）。";
      return;
    }

    btnUpload.disabled = true;
    btnNoAudio.disabled = true;

    try{
      setProg(0, "建立上傳通道…");
      const startRes = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify({
          mode:"startUpload",
          regId: current.regId,
          token: current.token,
          totalBytes: file.size,
          originalName: file.name
        })
      }).then(r=>r.json());

      if(!startRes.ok) throw new Error(startRes.error || "建立上傳通道失敗");

      const uploadUrl = startRes.uploadUrl;
      const finalName = startRes.finalName;

      const chunkSize = 1024*1024;
      let offset = 0;

      while(offset < file.size){
        const next = Math.min(offset + chunkSize, file.size);
        const blob = file.slice(offset, next);
        const buf = await blob.arrayBuffer();
        const chunkB64 = arrayBufferToBase64(buf);

        const start = offset;
        const end = next - 1;
        const pct = Math.round((next / file.size) * 100);
        setProg(pct, `上傳中… ${pct}%`);

        const chunkRes = await fetch(SCRIPT_URL, {
          method:"POST",
          headers:{ "Content-Type":"text/plain;charset=utf-8" },
          body: JSON.stringify({
            mode:"uploadChunk",
            regId: current.regId,
            token: current.token,
            uploadUrl: uploadUrl,
            start: start,
            end: end,
            total: file.size,
            chunkBase64: chunkB64
          })
        }).then(r=>r.json());

        if(!chunkRes.ok) throw new Error(chunkRes.error || "分段上傳失敗");

        if(chunkRes.done){
          setProg(100, "✅ 上傳完成");
          audioMsg.className = "ok";
          audioMsg.innerHTML =
            `✅ 已上傳音檔（已完成）<br>` +
            `檔名：<b>${esc(chunkRes.fileName || finalName)}</b><br>` +
            `連結：<a href="${chunkRes.fileUrl}" target="_blank" rel="noreferrer">點我檢視</a>`;

          current.audioUrl = chunkRes.fileUrl || "";
          current.hasAudio = !!current.audioUrl;

          // ✅ 只顯示第2張圖那種完成框（倒數20秒）
          showNotice("✅ 已完成", "");
          return;
        }

        offset = next;
      }

      setProg(100, "上傳完成，正在處理…");
      audioMsg.textContent = "上傳完成，正在處理…";

    }catch(e){
      setProg(0, "上傳失敗");
      audioMsg.className = "err";
      audioMsg.textContent = "上傳失敗：" + e.message;
    }finally{
      btnUpload.disabled = false;
      btnNoAudio.disabled = false;
    }
  });

  // 不需要音檔（完成）：若原本有音檔 → 清除（你要求）
  btnNoAudio.addEventListener("click", async ()=>{
    audioMsg.className = "muted";
    audioMsg.textContent = "";

    if(!current.regId || !current.token){
      audioMsg.className = "err";
      audioMsg.textContent = "請先完成報名或載入資料。";
      return;
    }

    btnUpload.disabled = true;
    btnNoAudio.disabled = true;

    try{
      const j = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify({
          mode:"noAudio",
          regId: current.regId,
          token: current.token
        })
      }).then(r=>r.json());

      if(!j.ok) throw new Error(j.error || "處理失敗");

      // 清掉前端狀態
      current.hasAudio = false;
      current.audioUrl = "";
      audioMsg.className = "ok";
      audioMsg.textContent = "✅ 已完成";

      showNotice("✅ 已完成", "");
    }catch(e){
      audioMsg.className = "err";
      audioMsg.textContent = "處理失敗：" + e.message;
    }finally{
      btnUpload.disabled = false;
      btnNoAudio.disabled = false;
    }
  });

  // 初始化（信件/ PDF 連結回來會進 edit 模式）
  initFromQuery();
</script>
</body>
</html>
