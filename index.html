<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>柚子樂器成果展｜報名</title>
  <style>
    *{ box-sizing:border-box; }
    html,body{ width:100%; overflow-x:hidden; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
      background:#faf7f8;
      color:#222;
    }
    .wrap{ max-width:860px; margin:24px auto; padding:16px; }
    .card{
      background:#fff;
      border:1px solid #eee;
      border-radius:16px;
      padding:18px;
      box-shadow:0 8px 22px rgba(0,0,0,.06);
    }
    h1{ margin:0 0 10px; font-size:22px; }
    .muted{ color:#666; font-size:13px; line-height:1.6; white-space:pre-wrap; }
    label{ display:block; margin:12px 0 6px; font-weight:800; }
    input,select,textarea{
      width:100%;
      max-width:100%;
      display:block;
      padding:12px;
      border:1px solid #ddd;
      border-radius:12px;
      font-size:16px;
      background:#fff;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{ border-color:#caa0ae; box-shadow:0 0 0 3px rgba(202,160,174,.25); }
    textarea{ min-height:90px; resize:vertical; }
    .row{
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(0,1fr);
      gap:12px;
    }
    @media (max-width:640px){ .row{ grid-template-columns:1fr; } }

    .btn{
      margin-top:14px;
      width:100%;
      padding:12px;
      border:0;
      border-radius:12px;
      font-size:16px;
      background:#7b3a52;
      color:#fff;
      cursor:pointer;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .btn2{
      margin-top:10px;
      width:100%;
      padding:12px;
      border:0;
      border-radius:12px;
      font-size:16px;
      background:#2f8f7b;
      color:#fff;
      cursor:pointer;
    }
    .btn2:disabled{ opacity:.6; cursor:not-allowed; }

    .btnGhost{
      margin-top:10px;
      width:100%;
      padding:12px;
      border:1px solid #ddd;
      border-radius:12px;
      font-size:16px;
      background:#fff;
      color:#333;
      cursor:pointer;
    }

    .ok{ color:#0a7a3c; font-weight:900; }
    .err{ color:#b00020; font-weight:900; }

    .box{
      background:#f6fbf9;
      border:1px solid #d7efe7;
      border-radius:12px;
      padding:12px;
      margin-top:14px;
    }
    .hr{ height:1px; background:#eee; margin:14px 0; }
    .bar{ width:100%; height:14px; }
    code{ background:#f6f6f6; padding:2px 6px; border-radius:8px; }

    /* ✅ 完成彈窗 */
    .modalMask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:16px;
      border:1px solid #eee;
      box-shadow:0 18px 40px rgba(0,0,0,.25);
      padding:16px;
    }
    .modal h3{ margin:0 0 8px; font-size:18px; }
    .modal .actions{ display:flex; gap:10px; margin-top:12px; }
    .modal .actions button{ flex:1; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>柚子樂器成果展｜報名</h1>
    <p class="muted" id="topHint">
      送出基本資料後，會直接出現「上傳 MP3」區塊（≤ 20MB）。\n
      檔名會自動改成：學生姓名_歌名_報名編號.mp3（學生不用自己改檔名）。
    </p>

    <form id="f">
      <label>場次 *</label>
      <select name="場次" required>
        <option value="">請選擇</option>
        <option>下午場 13:00~16:00</option>
        <option>晚上場 17:30~20:30</option>
      </select>

      <label>表演項目 *</label>
      <select name="表演項目" required>
        <option value="">請選擇</option>
        <option>熱音樂團</option>
        <option>輕音樂團</option>
        <option>吉他彈唱</option>
        <option>鋼琴獨奏</option>
        <option>鋼琴雙人</option>
        <option>小提琴</option>
        <option>中國笛</option>
        <option>長笛木笛直笛</option>
        <option>爵士鼓獨奏</option>
        <option>鋼琴彈唱</option>
        <option>二胡</option>
        <option>琵琶</option>
        <option>其他</option>
      </select>

      <label>學生姓名 *</label>
      <input name="學生姓名" required placeholder="例：王小明">

      <label>表演者姓名 / 團名 *</label>
      <input name="表演者姓名/團名" required placeholder="例：@@吉他社 / @@小提琴中心">

      <div class="row">
        <div>
          <label>舞台總表演人數 *</label>
          <input name="舞台總表演人數" required inputmode="numeric" placeholder="例：2 / 4">
        </div>
        <div>
          <label>聯絡電話 *</label>
          <input name="聯絡電話" required inputmode="tel" placeholder="例：0952-010146">
        </div>
      </div>

      <label>表演歌名/名稱 *</label>
      <input name="表演歌名/名稱" required placeholder="例：浪流連">

      <label>聯絡人信箱（老師代報也填老師信箱） *</label>
      <input name="聯絡人信箱" type="email" required placeholder="example@example.com">

      <label>老師是否一同表演</label>
      <select name="老師是否一同表演">
        <option value="">請選擇</option>
        <option>是</option>
        <option>否</option>
      </select>

      <label>老師一起的方式（沒有就留空）</label>
      <input name="老師一起的方式" placeholder="例：鋼琴伴奏">

      <label>老師姓名(代報填)</label>
      <input name="老師姓名(代報填)" placeholder="例：黃明廷">

      <label>需求/備註</label>
      <textarea name="需求/備註" placeholder="想補充的內容…"></textarea>

      <button class="btn" type="submit" id="btnSubmit">送出報名</button>
      <p id="msg" class="muted"></p>

      <!-- ✅ 上傳區（報名成功/修改模式都會顯示） -->
      <div class="box" id="audioBox" style="display:none;">
        <div class="muted" id="audioInfo"></div>
        <div class="hr"></div>

        <label style="margin-top:0;">上傳 MP3（≤ 20MB）</label>

        <!-- ✅ 把選檔放更顯眼 -->
        <input id="audioFile" type="file" accept="audio/mpeg,.mp3">
        <div class="muted" id="fileMeta"></div>

        <button type="button" class="btn2" id="btnUpload">上傳音檔</button>
        <button type="button" class="btnGhost" id="btnSkip">先不上傳（完成）</button>

        <div style="margin-top:10px;">
          <progress id="prog" class="bar" value="0" max="100"></progress>
          <div class="muted" id="progText">等待上傳…</div>
        </div>

        <p id="audioMsg" class="muted"></p>

        <div class="hr"></div>
        <p class="muted">
          若檔案超過 20MB，請先轉檔/壓縮後再上傳。\n
          你可以在 Google 搜尋「MP3 轉檔」快速找到工具。
        </p>
      </div>
    </form>
  </div>
</div>

<!-- ✅ 完成彈窗 -->
<div class="modalMask" id="doneMask">
  <div class="modal">
    <h3>✅ 音檔上傳完成</h3>
    <div class="muted" id="doneText"></div>
    <div class="actions">
      <button class="btn2" id="btnDoneOpen" type="button">檢視音檔</button>
      <button class="btnGhost" id="btnDoneClose" type="button">關閉</button>
    </div>
  </div>
</div>

<script>
  // ✅ 換成你目前「有效」的 Web App /exec（你最新部署那條）
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyeOeFb5TpiWga7GecrRbUA9x3W-cMGdT5XA5vQetjZYKWAl0_RhrDYuFXOBxW2bXXP/exec";

  const f = document.getElementById("f");
  const msg = document.getElementById("msg");
  const btnSubmit = document.getElementById("btnSubmit");

  const audioBox = document.getElementById("audioBox");
  const audioInfo = document.getElementById("audioInfo");
  const audioFile = document.getElementById("audioFile");
  const btnUpload = document.getElementById("btnUpload");
  const btnSkip = document.getElementById("btnSkip");
  const audioMsg = document.getElementById("audioMsg");
  const fileMeta = document.getElementById("fileMeta");

  const prog = document.getElementById("prog");
  const progText = document.getElementById("progText");

  const doneMask = document.getElementById("doneMask");
  const doneText = document.getElementById("doneText");
  const btnDoneOpen = document.getElementById("btnDoneOpen");
  const btnDoneClose = document.getElementById("btnDoneClose");

  let editMode = false;
  let current = { regId:"", token:"", student:"", song:"", fileUrl:"" };

  function setProg(pct, text){
    prog.value = Math.max(0, Math.min(100, pct));
    progText.textContent = text || `${prog.value}%`;
  }

  function resetUploadUI(){
    setProg(0, "等待上傳…");
    audioMsg.className = "muted";
    audioMsg.textContent = "";
    btnUpload.disabled = false;
  }

  function mb(n){ return (n / (1024*1024)); }
  function fmtMB(n){ return (Math.round(mb(n)*100)/100).toFixed(2); }

  function showDoneModal(fileName, fileUrl){
    current.fileUrl = fileUrl || "";
    doneText.textContent = `檔名：${fileName || ""}\n報名編號：${current.regId}`;
    btnDoneOpen.disabled = !current.fileUrl;
    doneMask.style.display = "flex";
  }
  btnDoneClose.addEventListener("click", ()=> doneMask.style.display="none");
  btnDoneOpen.addEventListener("click", ()=>{
    if(current.fileUrl) window.open(current.fileUrl, "_blank", "noreferrer");
  });

  function getQuery(){
    const p = new URLSearchParams(location.search);
    return {
      regId: (p.get("regId") || "").trim(),
      token: (p.get("token") || "").trim()
    };
  }

  async function initFromQuery(){
    const q = getQuery();
    if(!q.regId || !q.token) return;

    editMode = true;
    btnSubmit.textContent = "儲存修改（覆蓋）";
    msg.className = "muted";
    msg.textContent = "讀取已報名資料中…";

    try{
      const j = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify({ mode:"get", regId:q.regId, token:q.token })
      }).then(r=>r.json());

      if(!j.ok) throw new Error(j.error || "讀取失敗");

      const data = j.data || {};
      for(const k in data){
        const el = f.querySelector(`[name="${k}"]`);
        if(el) el.value = data[k];
      }

      current.regId = q.regId;
      current.token = q.token;
      current.student = (data["學生姓名"]||"").trim();
      current.song = (data["表演歌名/名稱"]||"").trim();

      audioBox.style.display = "";
      audioInfo.innerHTML =
        `（修改模式）報名編號：<b>${current.regId}</b><br>` +
        `學生：<b>${current.student}</b>　歌名：<b>${current.song}</b><br>` +
        `檔名會自動改成：<code>${current.student}_${current.song}_${current.regId}.mp3</code><br>` +
        (j.audio && j.audio.fileUrl ? `目前音檔：<a href="${j.audio.fileUrl}" target="_blank" rel="noreferrer">點我檢視</a>` : `目前音檔：尚未上傳`);

      msg.className = "ok";
      msg.textContent = "✅ 已進入修改模式：可直接覆蓋資料，音檔也可重傳覆蓋。";
      resetUploadUI();
    }catch(e){
      msg.className = "err";
      msg.textContent = "讀取失敗：" + e.message;
    }
  }

  // 送出 / 儲存修改（同一顆按鈕）
  f.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    msg.className = "muted";
    msg.textContent = editMode ? "儲存修改中…" : "送出中…";
    btnSubmit.disabled = true;

    const data = Object.fromEntries(new FormData(f).entries());

    if(editMode){
      data.mode = "update";
      data.regId = current.regId;
      data.token = current.token;
    }else{
      data.mode = "create";
    }

    try{
      const j = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify(data)
      }).then(r=>r.json());

      if(!j.ok) throw new Error(j.error || "unknown");

      msg.className = "ok";
      msg.textContent = editMode
        ? "✅ 修改已儲存（已覆蓋原資料）。下面可重傳音檔覆蓋。"
        : "✅ 基本資料已送出！下面可直接上傳 MP3。";

      // 建立 current（新建或更新後都要刷新）
      current.regId = j.regId || current.regId;
      current.token = j.token || current.token;
      current.student = (data["學生姓名"]||"").trim();
      current.song = (data["表演歌名/名稱"]||"").trim();

      audioBox.style.display = "";
      audioInfo.innerHTML =
        `報名編號：<b>${current.regId}</b><br>` +
        `學生：<b>${current.student}</b>　歌名：<b>${current.song}</b><br>` +
        `檔名會自動改成：<code>${current.student}_${current.song}_${current.regId}.mp3</code>`;

      resetUploadUI();

      // 新建成功後：把按鈕淡出（避免不直覺）
      if(!editMode){
        btnSubmit.style.opacity = "0.35";
        btnSubmit.disabled = true;
      }

      // 捲到上傳區
      audioBox.scrollIntoView({ behavior:"smooth", block:"start" });

    }catch(e){
      msg.className = "err";
      msg.textContent = (editMode ? "儲存失敗：" : "送出失敗：") + e.message;
    }finally{
      if(editMode) btnSubmit.disabled = false;
    }
  });

  btnSkip.addEventListener("click", () => {
    audioMsg.className = "ok";
    audioMsg.textContent = "✅ 已完成（可之後再用信件連結回來補上傳/修改/重傳覆蓋）。";
  });

  // 選檔後顯示大小
  audioFile.addEventListener("change", ()=>{
    const file = audioFile.files && audioFile.files[0];
    if(!file){ fileMeta.textContent=""; return; }

    const sizeMB = fmtMB(file.size);
    fileMeta.textContent = `已選擇：${file.name}（${sizeMB} MB）`;

    if(file.size > 20*1024*1024){
      fileMeta.textContent += `\n⚠️ 超過 20 MB，請先轉檔/壓縮後再上傳（可在 Google 搜尋「MP3 轉檔」）。`;
    }
  });

  // ArrayBuffer -> base64（較穩）
  function arrayBufferToBase64(buf){
    const bytes = new Uint8Array(buf);
    let bin = "";
    const step = 0x8000; // 32KB
    for(let i=0;i<bytes.length;i+=step){
      bin += String.fromCharCode(...bytes.subarray(i, i+step));
    }
    return btoa(bin);
  }

  btnUpload.addEventListener("click", async () => {
    audioMsg.className = "muted";
    audioMsg.textContent = "";

    if(!current.regId || !current.token){
      audioMsg.className = "err";
      audioMsg.textContent = "請先送出/讀取報名資料。";
      return;
    }

    const file = audioFile.files && audioFile.files[0];
    if(!file){
      audioMsg.className = "err";
      audioMsg.textContent = "請先選擇 MP3 檔案。";
      return;
    }

    const maxBytes = 20 * 1024 * 1024;
    if(file.size > maxBytes){
      audioMsg.className = "err";
      audioMsg.textContent =
        `檔案太大：目前 ${fmtMB(file.size)} MB，超過 20 MB，請先轉檔/壓縮後再上傳。\n` +
        `你可以在 Google 搜尋「MP3 轉檔」。`;
      return;
    }

    const lowerName = (file.name || "").toLowerCase();
    const isMp3 = (file.type === "audio/mpeg") || lowerName.endsWith(".mp3");
    if(!isMp3){
      audioMsg.className = "err";
      audioMsg.textContent = "只接受 MP3（.mp3）。";
      return;
    }

    btnUpload.disabled = true;

    try{
      setProg(0, "建立上傳通道…");

      const startRes = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify({
          mode:"startUpload",
          regId: current.regId,
          token: current.token,
          totalBytes: file.size,
          originalName: file.name
        })
      }).then(r => r.json());

      if(!startRes.ok){
        throw new Error((startRes.error || "建立上傳通道失敗") + (startRes.detail ? ("\n" + startRes.detail) : ""));
      }

      const uploadUrl = startRes.uploadUrl;
      const finalName = startRes.finalName;

      const chunkSize = 1024 * 1024; // 1MB
      let offset = 0;

      while(offset < file.size){
        const next = Math.min(offset + chunkSize, file.size);
        const blob = file.slice(offset, next);
        const buf = await blob.arrayBuffer();
        const chunkB64 = arrayBufferToBase64(buf);

        const start = offset;
        const end = next - 1;

        const pct = Math.round((next / file.size) * 100);
        setProg(pct, `上傳中… ${pct}%`);

        const chunkRes = await fetch(SCRIPT_URL, {
          method:"POST",
          headers:{ "Content-Type":"text/plain;charset=utf-8" },
          body: JSON.stringify({
            mode:"uploadChunk",
            regId: current.regId,
            token: current.token,
            uploadUrl,
            start,
            end,
            total: file.size,
            chunkBase64: chunkB64
          })
        }).then(r => r.json());

        if(!chunkRes.ok){
          throw new Error((chunkRes.error || "分段上傳失敗") + (chunkRes.detail ? ("\n" + chunkRes.detail) : ""));
        }

        if(chunkRes.done){
          setProg(100, "✅ 上傳完成");
          audioMsg.className = "ok";
          audioMsg.innerHTML =
            `✅ 音檔已上傳完成<br>` +
            `檔名：<b>${chunkRes.fileName || finalName}</b><br>` +
            `連結：<a href="${chunkRes.fileUrl}" target="_blank" rel="noreferrer">點我檢視</a>`;

          // ✅ 跳出完成框
          showDoneModal(chunkRes.fileName || finalName, chunkRes.fileUrl);
          return;
        }

        offset = next;
      }

      // 100% 但後台可能還在回寫
      setProg(100, "上傳完成，正在處理與回寫資料…");
      audioMsg.className = "muted";
      audioMsg.textContent = "上傳完成，正在處理與回寫資料…";

    }catch(e){
      setProg(0, "上傳失敗");
      audioMsg.className = "err";
      audioMsg.textContent = "上傳失敗：" + e.message;
    }finally{
      btnUpload.disabled = false;
    }
  });

  // 初始化（信箱連結回來會自動進修改模式）
  initFromQuery();
</script>
</body>
</html>
